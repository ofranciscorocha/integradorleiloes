<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Center - CARS LEIL√ïES</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #FF9F1C;
            --accent: #22c55e;
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --sidebar-width: 260px;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --glass: rgba(15, 23, 42, 0.6);
            --danger: #ef4444;
            --warning: #fbbf24;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, rgba(255, 159, 28, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(34, 197, 94, 0.05) 0px, transparent 50%);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--border);
            padding: 2.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.2rem;
            margin-bottom: 3rem;
            color: white;
            letter-spacing: -0.5px;
        }

        .sidebar-logo b {
            color: var(--primary);
        }

        .nav-list {
            list-style: none;
            flex: 1;
        }

        .nav-list li {
            margin-bottom: 0.6rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            color: var(--text-dim);
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary), #fbbf24);
            color: #000;
            box-shadow: 0 10px 15px -3px rgba(255, 159, 28, 0.3);
        }

        .logout-btn {
            margin-top: auto;
            color: var(--danger);
            opacity: 0.8;
        }

        .logout-btn:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.1);
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 900;
            backdrop-filter: blur(4px);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2.5rem 3rem;
            width: calc(100% - var(--sidebar-width));
            transition: all 0.3s;
        }

        .mobile-header {
            display: none;
            padding: 1rem;
            background: var(--glass);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            justify-content: space-between;
            align-items: center;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        section {
            display: none;
        }

        section.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 3rem;
        }

        .header-title h1 {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .header-title p {
            color: var(--text-dim);
            margin-top: 5px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 1.8rem;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin: 10px 0;
            display: block;
        }

        .kpi-trend {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Crawler Grid/Table */
        .crawler-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.2rem;
            margin-bottom: 2rem;
        }

        .crawler-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: 18px;
            transition: all 0.3s;
            position: relative;
        }

        .crawler-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-idle {
            background: var(--text-dim);
        }

        .status-running {
            background: #facc15;
            /* Yellow-400 */
            box-shadow: 0 0 15px #facc15;
            animation: pulse 1.5s infinite;
        }

        .status-error {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .status-online {
            background: var(--accent);
        }

        /* Card States */
        @keyframes border-pulse-yellow {
            0% {
                border-color: rgba(250, 204, 21, 0.3);
                box-shadow: 0 0 0 rgba(250, 204, 21, 0);
            }

            50% {
                border-color: rgba(250, 204, 21, 0.8);
                box-shadow: 0 0 15px rgba(250, 204, 21, 0.2);
            }

            100% {
                border-color: rgba(250, 204, 21, 0.3);
                box-shadow: 0 0 0 rgba(250, 204, 21, 0);
            }
        }

        .card-running {
            border-color: #facc15 !important;
            animation: border-pulse-yellow 2s infinite;
        }

        .card-error {
            border-color: var(--danger) !important;
            background: rgba(239, 68, 68, 0.05);
        }

        .card-success {
            border-color: var(--accent) !important;
            background: rgba(34, 197, 94, 0.05);
        }

        .crawler-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .crawler-name {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .crawler-info {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 1.5rem;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid var(--border);
        }

        /* Terminal */
        .terminal {
            background: #020617;
            border-radius: 18px;
            border: 1px solid var(--border);
            margin-top: 2rem;
            overflow: hidden;
        }

        .terminal-header {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .terminal-body {
            height: 350px;
            padding: 1.5rem;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #cbd5e1;
        }

        .line {
            margin-bottom: 4px;
            border-left: 2px solid transparent;
            padding-left: 10px;
        }

        .line-info {
            color: #38bdf8;
            border-color: #38bdf8;
        }

        .line-success {
            color: #4ade80;
            border-color: #4ade80;
        }

        .line-error {
            color: #f87171;
            border-color: #f87171;
        }

        /* Dashboard widgets */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1.8fr 1.2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .widget {
            background: var(--glass);
            border-radius: 20px;
            padding: 1.8rem;
            border: 1px solid var(--border);
        }

        .widget-title {
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 1.1rem;
        }

        .widget-title i {
            color: var(--primary);
        }

        .site-list {
            list-style: none;
        }

        .site-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .site-item:last-child {
            border-bottom: none;
        }

        .site-item-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .site-item-count {
            font-weight: 700;
            color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                left: -260px;
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1.5rem;
            }

            .mobile-header {
                display: flex;
            }

            .mobile-overlay.active {
                display: block;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
            }

            .header-actions .btn {
                width: 100%;
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="mobile-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="mobile-header">
        <div class="sidebar-logo" style="margin-bottom: 0; padding: 0.5rem 0;">
            <img src="/img/logo.png" alt="CARS LEIL√ïES" style="height: 35px; width: auto; object-fit: contain;">
        </div>
        <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo" style="margin-bottom: 2rem;">
            <img src="/img/logo.png" alt="CARS LEIL√ïES"
                style="width: 100%; height: auto; max-height: 60px; object-fit: contain;">
        </div>
        <ul class="nav-list">
            <li>
                <div class="nav-link active" onclick="switchSection('dashboard')"><i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </div>
            </li>
            <li>
                <div class="nav-link" onclick="switchSection('crawlers')"><i class="fas fa-robot"></i> <span>Motores
                        (Crawlers)</span></div>
            </li>
            <li>
                <div class="nav-link" onclick="switchSection('engine')"><i class="fas fa-database"></i>
                    <span>Banco de Dados</span>
                </div>
            </li>
            <li>
                <div class="nav-link" onclick="switchSection('branding')"><i class="fas fa-palette"></i>
                    <span>Customizar
                        Site</span>
                </div>
            </li>
        </ul>
        <div class="nav-link logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> <span>Sair do Sistema</span>
        </div>
    </aside>

    <main class="main-content">
        <header>
            <div class="header-title" style="flex: 1;">
                <h1 id="page-title">Painel de Controle</h1>
                <p id="timestamp">Aguardando sincroniza√ß√£o...</p>
            </div>
            <div class="header-actions">
                <a href="/" target="_blank" class="btn btn-outline"><i class="fas fa-external-link"></i> Abrir Site
                    P√∫blico</a>
            </div>
        </header>

        <!-- DASHBOARD SECTION -->
        <section id="section-dashboard" class="active">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <span class="kpi-label">Ve√≠culos em Base</span>
                    <span class="kpi-value" id="kpi-total">---</span>
                    <div class="kpi-trend" style="color: var(--accent);"><i class="fas fa-check-circle"></i>
                        Vivos na Web</div>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Captura 24h</span>
                    <span class="kpi-value" id="kpi-daily" style="color: var(--primary)">---</span>
                    <div class="kpi-trend" style="color: var(--text-dim);">Novos lotes hoje</div>
                </div>
                <div class="kpi-card">
                    <span class="kpi-label">Health Score</span>
                    <span class="kpi-value" id="kpi-active" style="color: var(--accent);">98%</span>
                    <div class="kpi-trend" style="color: var(--accent);"><i class="fas fa-shield-check"></i> Sistema OK
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="widget">
                    <div class="widget-title"><i class="fas fa-store"></i> Distribui√ß√£o por Leiloeiro</div>
                    <ul class="site-list" id="site-distribution">
                        <li style="padding: 2rem; text-align: center; color: var(--text-dim);"><i
                                class="fas fa-spinner fa-spin"></i> Carregando lista...</li>
                    </ul>
                </div>
                <div class="widget">
                    <div class="widget-title"><i class="fas fa-chart-pie"></i> Visualiza√ß√£o Gr√°fica</div>
                    <div
                        style="position: relative; height: 300px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="sites-chart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- CRAWLERS SECTION -->
        <section id="section-crawlers">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div class="widget-title" style="margin-bottom: 0;"><i class="fas fa-robot"></i> Gerenciamento de Coleta
                </div>
                <button class="btn btn-primary" onclick="runAllCrawlers()" id="btn-crawl-all">
                    <i class="fas fa-play"></i> Iniciar Coleta Sequencial Total
                </button>
            </div>

            <div class="crawler-grid" id="crawler-list">
                <!-- Cards inject via JS -->
            </div>

            <div class="terminal">
                <div class="terminal-header">
                    <span><i class="fas fa-terminal"></i> CONSOLE_LOG.output</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" style="padding: 4px 10px; font-size: 0.7rem;"
                            onclick="clearTerminal()">Limpar</button>
                    </div>
                </div>
                <div class="terminal-body" id="terminal-output">
                    <div class="line line-info">Otimizando motores de busca... Aguardando comando.</div>
                </div>
            </div>
        </section>

        <!-- ENGINE SETTINGS SECTION -->
        <section id="section-engine">
            <div class="dashboard-grid">
                <div class="widget">
                    <div class="widget-title"><i class="fas fa-database"></i> Manuten√ß√£o da Base</div>
                    <p style="color: var(--text-dim); margin-bottom: 1.5rem; font-size: 0.9rem;">Execute tarefas de
                        limpeza e otimiza√ß√£o para manter o sistema r√°pido e livre de lixo.</p>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button class="btn btn-outline" style="justify-content: flex-start;" onclick="cleanExpired()">
                            <i class="fas fa-broom"></i> Deletar Leil√µes Vencidos (Ontem ou antes)
                        </button>
                        <button class="btn btn-outline" style="justify-content: flex-start;" onclick="refreshDB()">
                            <i class="fas fa-sync"></i> Resetar Cache de Mem√≥ria
                        </button>
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-title"><i class="fas fa-clock"></i> Agendamentos Atuais</div>
                    <div class="form-group">
                        <label>Ciclos de Varredura</label>
                        <div
                            style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 12px; border: 1px dashed var(--border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span><i class="fas fa-sun"></i> Ciclo Diurno</span>
                                <b style="color: var(--primary);">A cada 12h</b>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span><i class="fas fa-moon"></i> Pr√≥xima Coleta</span>
                                <b style="color: var(--accent);">Autom√°tica</b>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BRANDING SECTION -->
        <section id="section-branding">
            <div class="widget" style="max-width: 650px;">
                <div class="widget-title"><i class="fas fa-image"></i> Identidade Visual do Site</div>
                <p style="color: var(--text-dim); margin-bottom: 2rem; font-size: 0.9rem;">Altera√ß√µes aqui afetam o site
                    p√∫blico instantaneamente.</p>
                <div class="form-group">
                    <label>Logo do Cabe√ßalho (PNG Transparente preferencial)</label>
                    <input type="file" id="logo-input" class="form-control" style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="uploadBranding('logo')">Atualizar Logo</button>
                </div>
                <div class="form-group"
                    style="margin-top: 2.5rem; border-top: 1px solid var(--border); padding-top: 2rem;">
                    <label>Fundo da Hero Principal (Wallpaper 1920x1080)</label>
                    <input type="file" id="hero-input" class="form-control" style="margin-bottom: 1rem;">
                    <button class="btn btn-primary" onclick="uploadBranding('hero')">Atualizar Wallpaper</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        const token = localStorage.getItem('admin_token');
        if (!token) window.location.href = '/login.html';

        let chart = null;

        async function init() {
            updateTime();
            setInterval(updateTime, 1000);
            await loadData();
            setInterval(loadData, 20000); // 20s auto refresh for more "alive" feel
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('timestamp').innerText = `Sync: ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR')}`;
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        async function loadData() {
            try {
                const res = await fetch('/stats', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.status === 401) logout();

                const data = await res.json();
                if (data.success) {
                    renderStats(data);
                    renderCrawlers(data.stats.scheduler || {}, data.stats.porSite || {});
                    renderChart(data.stats.porSite || {});
                    renderDistribution(data.stats.porSite || {});
                }
            } catch (e) { console.error('Data Load Error:', e); }
        }

        function renderStats(data) {
            document.getElementById('kpi-total').innerText = (data.total || 0).toLocaleString();
            document.getElementById('kpi-daily').innerText = '+' + (data.stats.novosHoje || 0);
        }

        function renderCrawlers(scheduler, sites) {
            const container = document.getElementById('crawler-list');
            const crawlers = scheduler.crawlers || {};

            if (Object.keys(crawlers).length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-dim); padding: 3rem;">Nenhum leiloeiro configurado.</div>';
                return;
            }

            container.innerHTML = Object.entries(crawlers).map(([id, info]) => {
                const isRunning = info.status === 'running';
                const isError = info.status === 'error';

                // DATA COUNT
                const siteData = sites[id] || { count: 0 };
                const count = siteData.count || 0;
                const hasItems = count > 10;

                // STATUS ANIMATION LOGIC
                let statusLabel = 'Aguardando';
                let dotClass = 'status-idle';
                let cardClass = '';

                if (isRunning) {
                    statusLabel = 'Coletando...';
                    dotClass = 'status-running'; // Yellow pulse
                    cardClass = 'card-running';
                } else if (isError) {
                    statusLabel = 'Falhou';
                    dotClass = 'status-error'; // Red
                    cardClass = 'card-error';
                } else if (hasItems) {
                    statusLabel = 'Online';
                    dotClass = 'status-online'; // Green
                    cardClass = 'card-success';
                }

                // BUTTON LOGIC
                const btnStyle = isRunning
                    ? ''
                    : (hasItems ? 'background: var(--accent); color: white; border: none; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);' : (isError ? 'border-color: var(--danger); color: var(--danger);' : ''));

                const btnText = isRunning ? 'Coletando...' : (hasItems ? 'Atualizar Base' : (isError ? 'Tentar Novamente' : 'Rodar Agora'));
                const btnIcon = isRunning ? 'fa-spinner fa-spin' : (isError ? 'fa-redo' : 'fa-play');



                return `
                    <div class="crawler-card ${cardClass}" style="transition: all 0.3s;">
                        <div class="crawler-header">
                            <span class="crawler-name">${info.name}</span>
                            <div style="font-size: 0.75rem; display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 20px;">
                                <span class="status-dot ${dotClass}"></span> ${statusLabel}
                            </div>
                        </div>
                        <div class="crawler-info">
                            <p style="margin-bottom: 5px;"><i class="far fa-clock"></i> √öltimo: ${info.lastRun ? new Date(info.lastRun).toLocaleTimeString() : 'Nunca'}</p>
                            <p style="margin-bottom: 5px;"><i class="fas fa-car"></i> Ve√≠culos: <b style="color: ${hasItems ? 'var(--accent)' : 'inherit'}">${count}</b></p>
                            <p><i class="fas fa-tag"></i> ID: <b>${id}</b></p>
                        </div>
                        <button class="btn btn-outline" style="width: 100%; border-radius: 10px; font-size: 0.8rem; ${btnStyle}" onclick="runCrawler('${id}')" ${isRunning ? 'disabled' : ''}>
                            <i class="fas ${btnIcon}"></i> 
                            ${btnText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderDistribution(sites) {
            const container = document.getElementById('site-distribution');
            const entries = Object.entries(sites);

            if (entries.length === 0) {
                container.innerHTML = '<li style="text-align: center; color: var(--text-dim);">Sem dados de distribui√ß√£o.</li>';
                return;
            }

            // Sort by count desc
            entries.sort((a, b) => b[1].count - a[1].count);

            container.innerHTML = entries.map(([id, data]) => `
                <li class="site-item">
                    <span class="site-item-name"><i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i> ${data.name}</span>
                    <span class="site-item-count">${data.count.toLocaleString()} <span style="font-size: 0.7rem; color: var(--text-dim); font-weight: 400;">vcl</span></span>
                </li>
            `).join('');
        }

        function renderChart(sites) {
            const ctx = document.getElementById('sites-chart').getContext('2d');
            const entries = Object.entries(sites).filter(e => e[1].count > 0);
            const labels = entries.map(e => e[1].name);
            const data = entries.map(e => e[1].count);

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#FF9F1C', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#14b8a6', '#f59e0b', '#6366f1', '#94a3b8'],
                        hoverOffset: 15,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    cutout: '75%'
                }
            });
        }

        async function runCrawler(id) {
            switchSection('crawlers');
            appendTerminal(`üîÑ Gatilho manual enviado para: ${id}...`, 'info');
            try {
                const res = await fetch('/admin/crawl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ site: id })
                });
                const data = await res.json();
                if (data.success) {
                    appendTerminal(`‚úÖ Motor ${id} sincronizado. Abrindo canal de log...`, 'success');
                    startPolling();
                } else {
                    appendTerminal(`‚ùå Falha no motor: ${data.error}`, 'error');
                }
            } catch (e) { appendTerminal(`‚ùå Erro cr√≠tico de rede.`, 'error'); }
        }

        async function runAllCrawlers() {
            if (!confirm('Iniciar varredura total? Isso consumir√° recursos do servidor.')) return;
            const btn = document.getElementById('btn-crawl-all');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Em andamento...';

            appendTerminal(`üöÄ COLETA TOTAL INICIADA. Sincronizando todos os leiloeiros...`, 'info');
            try {
                const res = await fetch('/admin/crawl-all', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success) {
                    startPolling();
                } else {
                    alert(data.error);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play"></i> Iniciar Coleta Sequencial Total';
                }
            } catch (e) { appendTerminal(`‚ùå Erro ao disparar varredura total.`, 'error'); btn.disabled = false; }
        }

        let pollInterval = null;
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(async () => {
                const res = await fetch('/admin/logs', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (data.success && data.logs) {
                    const output = document.getElementById('terminal-output');
                    output.innerHTML = data.logs.split('\n').map(line => {
                        let type = 'info';
                        if (line.includes('ERROR') || line.includes('Erro')) type = 'error';
                        if (line.includes('finished') || line.includes('Saved') || line.includes('‚úÖ')) type = 'success';
                        return `<div class="line line-${type}">${line}</div>`;
                    }).join('');
                    output.scrollTop = output.scrollHeight;

                    if (data.logs.includes('All scheduled crawlers finished')) {
                        clearInterval(pollInterval);
                        loadData();
                        document.getElementById('btn-crawl-all').disabled = false;
                        document.getElementById('btn-crawl-all').innerHTML = '<i class="fas fa-play"></i> Iniciar Coleta Sequencial Total';
                    }
                }
            }, 2500);
        }

        function switchSection(id) {
            if (window.innerWidth <= 1024) toggleSidebar();

            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            const activeLink = document.querySelector(`[onclick="switchSection('${id}')"]`);
            if (activeLink) activeLink.classList.add('active');

            const titles = { dashboard: 'Painel Geral', crawlers: 'Motores de Busca', engine: 'Dados & Cache', branding: 'Identidade Visual' };
            document.getElementById('page-title').innerText = titles[id];
        }

        function appendTerminal(msg, type) {
            const out = document.getElementById('terminal-output');
            out.innerHTML += `<div class="line line-${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            out.scrollTop = out.scrollHeight;
        }

        function clearTerminal() { document.getElementById('terminal-output').innerHTML = ''; }

        async function uploadBranding(type) {
            const input = document.getElementById(`${type}-input`);
            if (!input.files[0]) return alert('Por favor, selecione um arquivo primeiro.');

            const reader = new FileReader();
            reader.readAsDataURL(input.files[0]);
            reader.onload = async () => {
                const res = await fetch('/admin/upload-branding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ type, base64Data: reader.result })
                });
                const data = await res.json();
                if (data.success) alert('Enviado com sucesso! Atualize o site para ver as mudan√ßas.');
                else alert('Erro: ' + data.error);
            };
        }

        async function cleanExpired() {
            if (!confirm('Tem certeza que deseja limpar leil√µes antigos?')) return;
            const res = await fetch('/admin/clean', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            alert(`Limpeza completa. ${data.removed} ve√≠culos removidos.`);
            loadData();
        }

        async function refreshDB() {
            await fetch('/admin/refresh-db', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
            alert('Banco de dados e Cache sincronizados!');
            loadData();
        }

        function logout() { localStorage.removeItem('admin_token'); window.location.href = '/login.html'; }

        init();
    </script>
</body>

</html>