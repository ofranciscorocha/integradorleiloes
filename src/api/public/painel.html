<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Center - CARS LEIL√ïES</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #FF9F1C;
            --accent: #22c55e;
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --sidebar-width: 260px;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --glass: rgba(15, 23, 42, 0.6);
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, rgba(255, 159, 28, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(34, 197, 94, 0.05) 0px, transparent 50%);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--border);
            padding: 2.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-logo {
            font-family: 'Outfit', sans-serif;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.4rem;
            margin-bottom: 3rem;
            color: white;
            letter-spacing: -0.5px;
        }

        .sidebar-logo span {
            border-bottom: 3px solid var(--primary);
        }

        .nav-list {
            list-style: none;
            flex: 1;
        }

        .nav-list li {
            margin-bottom: 0.6rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            color: var(--text-dim);
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary), #fbbf24);
            color: #000;
            box-shadow: 0 10px 15px -3px rgba(255, 159, 28, 0.3);
        }

        .logout-btn {
            margin-top: auto;
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Main area */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2.5rem 3rem;
            max-width: 1600px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 3rem;
        }

        .header-title h1 {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .header-title p {
            color: var(--text-dim);
            margin-top: 5px;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 1.8rem;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .kpi-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            margin: 10px 0;
            display: block;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Layout columns */
        .grid-layout {
            display: grid;
            grid-template-columns: 1.8fr 1.2fr;
            gap: 2rem;
        }

        /* Crawler Cards */
        .crawler-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.2rem;
        }

        .crawler-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 1.2rem;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }

        .crawler-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--text-dim);
        }

        .crawler-card.online::before {
            background: var(--accent);
        }

        .crawler-card.running::before {
            background: var(--primary);
            animation: pulse 2s infinite;
        }

        .crawler-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .crawler-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .crawler-stats {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .crawler-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-glow {
            background: var(--primary);
            color: black;
            box-shadow: 0 4px 14px 0 rgba(255, 159, 28, 0.2);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid var(--border);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Unified Terminal */
        .terminal-container {
            background: #020617;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-top: 2rem;
            position: relative;
        }

        .terminal-header {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-body {
            height: 400px;
            overflow-y: auto;
            padding: 1.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .line {
            margin-bottom: 4px;
            border-left: 2px solid transparent;
            padding-left: 10px;
        }

        .line-info {
            color: #38bdf8;
            border-color: #38bdf8;
        }

        .line-success {
            color: #4ade80;
            border-color: #4ade80;
        }

        .line-error {
            color: #f87171;
            border-color: #f87171;
        }

        .line-warn {
            color: #fbbf24;
            border-color: #fbbf24;
        }

        /* Feed Columns */
        .feed-box {
            background: var(--glass);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            height: fit-content;
        }

        .feed-title {
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        @media (max-width: 1200px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <i class="fas fa-bolt" style="color: var(--primary);"></i>
            <span>CONTROL<b>CENTER</b></span>
        </div>
        <ul class="nav-list">
            <li><a href="#" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-grid-2"></i>
                    Dashboard</a></li>
            <li><a href="#" class="nav-link" onclick="showSection('crawlers')"><i class="fas fa-robot"></i> Crawlers</a>
            </li>
            <li><a href="#" class="nav-link" onclick="showSection('settings')"><i class="fas fa-sliders"></i> Engine
                    Fixes</a></li>
            <li><a href="#" class="nav-link" onclick="showSection('branding')"><i class="fas fa-paint-brush"></i> UI
                    Branding</a></li>
        </ul>
        <a href="#" class="nav-link logout-btn" onclick="logout()">
            <i class="fas fa-power-off"></i> Encerrar Sess√£o
        </a>
    </aside>

    <main class="main-content">
        <header>
            <div class="header-title">
                <h1>Sistema de Coleta</h1>
                <p id="time-display">Acompanhamento em tempo real ‚Ä¢ Vers√£o 2.4</p>
            </div>
            <div class="header-actions">
                <a href="/" target="_blank" class="btn btn-outline"><i class="fas fa-external-link"></i> Visualizar
                    Site</a>
            </div>
        </header>

        <!-- KPI GRID -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <span class="kpi-label">Base de Dados</span>
                <span class="kpi-value" id="stat-total">---</span>
                <div style="font-size: 0.7rem; color: var(--accent);"><i class="fas fa-arrow-up"></i> Crescimento
                    est√°vel</div>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Captura 24h</span>
                <span class="kpi-value" id="stat-today" style="color: var(--primary);">---</span>
                <div style="font-size: 0.7rem; color: var(--text-dim);">Novos registros hoje</div>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Leiloeiros</span>
                <span class="kpi-value" id="stat-sites">9</span>
                <div style="font-size: 0.7rem; color: var(--accent);"><i class="fas fa-check"></i> Todos ativos</div>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Sa√∫de Engine</span>
                <span class="kpi-value" style="color: var(--accent);">98%</span>
                <div style="font-size: 0.7rem; color: var(--text-dim);">Estabilidade de rede</div>
            </div>
        </div>

        <div class="grid-layout">
            <!-- LEFT: CRAWLERS & TERMINAL -->
            <div class="main-column">
                <div class="feed-title"><i class="fas fa-robot"></i> Motores de Busca</div>
                <div class="crawler-grid" id="crawler-container">
                    <!-- Cards via JS -->
                    <div class="kpi-card"
                        style="grid-column: span 2; display: flex; justify-content: center; padding: 3rem;">
                        <i class="fas fa-circle-notch fa-spin"></i>
                    </div>
                </div>

                <div class="terminal-container">
                    <div class="terminal-header">
                        <div style="display: flex; gap: 8px;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #ff5f56;"></span>
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #ffbd2e;"></span>
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #27c93f;"></span>
                        </div>
                        <div style="font-size: 0.7rem; font-family: 'JetBrains Mono'; color: var(--text-dim);">
                            CRAWLER_LOG_STREAM</div>
                        <button class="btn btn-outline" style="padding: 4px 8px; font-size: 0.7rem;"
                            onclick="clearTerminal()">Limpar</button>
                    </div>
                    <div class="terminal-body" id="crawler-console">
                        <div class="line line-info">Aguardando gatilho de execu√ß√£o...</div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: FEED & ANALYTICS -->
            <div class="side-column">
                <div class="feed-box">
                    <div class="feed-title"><i class="fas fa-bolt" style="color: var(--primary);"></i> Eventos Recentes
                    </div>
                    <div id="live-feed" style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="crawler-stats" style="text-align: center; padding: 2rem;">
                            Carregando feed de atividade...
                        </div>
                    </div>

                    <div class="feed-title" style="margin-top: 2.5rem;"><i class="fas fa-layer-group"></i> A√ß√µes
                        Administrativas</div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-glow" style="width: 100%; justify-content: center;"
                            onclick="runAllCrawlers()">
                            <i class="fas fa-play"></i> Rodar Coleta Sequencial
                        </button>
                        <button class="btn btn-outline" style="width: 100%; justify-content: center;"
                            onclick="cleanExpired()">
                            <i class="fas fa-broom"></i> Limpar Leil√µes Expirados
                        </button>
                        <button class="btn btn-outline" style="width: 100%; justify-content: center;"
                            onclick="refreshDB()">
                            <i class="fas fa-sync"></i> Sincronizar Base Local
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branding Section Hidden by default -->
        <section id="section-branding" style="display: none; margin-top: 3rem;">
            <div class="kpi-card">
                <div class="feed-title">Personaliza√ß√£o de Interface</div>
                <!-- Branding controls inherited from previous version but styled -->
                <div class="grid-layout">
                    <div>
                        <p class="crawler-stats">Logo (PNG/JPG)</p>
                        <input type="file" id="upload-logo" class="btn btn-outline"
                            style="width: 100%; margin: 10px 0;">
                        <button class="btn btn-glow" onclick="uploadBranding('logo')">Atualizar Logo</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const token = localStorage.getItem('admin_token');
        if (!token) window.location.href = '/login.html';

        const SITES_RESOURCES = {
            'palacio': { name: 'Pal√°cio dos Leil√µes', color: '#FF9F1C' },
            'vip': { name: 'VIP Leil√µes', color: '#3b82f6' },
            'guariglia': { name: 'Guariglia Leil√µes', color: '#22c55e' },
            'freitas': { name: 'Freitas Leiloeiro', color: '#8b5cf6' },
            'sodre': { name: 'Sodr√© Santoro', color: '#ec4899' },
            'copart': { name: 'Copart', color: '#14b8a6' },
            'rogeriomenezes': { name: 'Rog√©rio Menezes', color: '#f59e0b' },
            'parque': { name: 'Parque dos Leil√µes', color: '#6366f1' },
            'leilo': { name: 'Leilo.com.br', color: '#f97316' },
            'milan': { name: 'Milan Leil√µes', color: '#ef4444' },
            'sumare': { name: 'Sumar√© Leil√µes', color: '#84cc16' },
            'sato': { name: 'Sato Leil√µes', color: '#06b6d4' },
            'joaoemilio': { name: 'Jo√£o Em√≠lio', color: '#a855f7' },
            'mgl': { name: 'MGL Leil√µes', color: '#ec4899' },
            'claudiokuss': { name: 'Claudio Kuss Leil√µes', color: '#10b981' },
            'pestana': { name: 'Pestana Leil√µes', color: '#f43f5e' },
            'patiorocha': { name: 'P√°tio Rocha', color: '#64748b' },
            'superbid': { name: 'Superbid', color: '#fb923c' }
        };
Line 532:Line 533: async function init() {
Line 534: await loadDashboard();
Line 535: updateTime();
Line 536: setInterval(updateTime, 1000);
Line 537:            // Refresh counts periodically
Line 538: setInterval(loadDashboard, 30000);
Line 539:
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('time-display').innerText = `Status Operacional ‚Ä¢ ${now.toLocaleTimeString('pt-BR')} ‚Ä¢ ${now.toLocaleDateString('pt-BR')}`;
        }

        async function loadDashboard() {
            try {
                const res = await fetch('/stats');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('stat-total').innerText = data.total;
                    document.getElementById('stat-today').innerText = data.stats.novosHoje || 0;

                    renderCrawlerCards(data.stats.porSite, data.stats.scheduler);
                    renderLiveFeed(data.ultimos || []);
                }
            } catch (e) {
                console.error('Dash error', e);
            }
        }

        function renderCrawlerCards(stats, scheduler) {
            const container = document.getElementById('crawler-container');
            const runningSite = scheduler.running ? (localStorage.getItem('running_crawler') || 'all') : null;

            container.innerHTML = Object.entries(SITES_RESOURCES).map(([id, info]) => {
                const count = stats[info.name] || 0;
                const isRunning = runningSite === 'all' || runningSite === id;
                const statusClass = isRunning ? 'running' : (count > 0 ? 'online' : '');

                return `
                    <div class="crawler-card ${statusClass}">
                        <div class="crawler-header">
                            <div>
                                <div class="crawler-name">${info.name}</div>
                                <div class="crawler-stats">${count} autom√≥veis ativos</div>
                            </div>
                            <i class="fas ${isRunning ? 'fa-spinner fa-spin' : 'fa-check-circle'}" 
                               style="color: ${isRunning ? 'var(--primary)' : (count > 0 ? 'var(--accent)' : 'var(--text-dim)')}"></i>
                        </div>
                        <div class="crawler-actions">
                            <button class="btn btn-outline" style="flex: 1; padding: 6px;" onclick="runCrawler('${id}')">
                                <i class="fas fa-play"></i> Iniciar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLiveFeed(recent) {
            const container = document.getElementById('live-feed');
            if (recent.length === 0) {
                container.innerHTML = '<div class="crawler-stats">Nenhuma atividade recente detectada.</div>';
                return;
            }

            container.innerHTML = recent.slice(0, 5).map(item => `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; gap: 10px; align-items: center;">
                    <div style="width: 40px; height: 40px; border-radius: 8px; background: #334155; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--primary);">
                        <i class="fas fa-car-side"></i>
                    </div>
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-size: 0.8rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.veiculo}</div>
                        <div style="font-size: 0.65rem; color: var(--text-dim);">${item.site} ‚Ä¢ ${new Date(item.criadoEm).toLocaleTimeString()}</div>
                    </div>
                </div>
            `).join('');
        }

        async function runCrawler(site) {
            localStorage.setItem('running_crawler', site);
            const consoleEl = document.getElementById('crawler-console');
            consoleEl.innerHTML = `<div class="line line-info">üîÑ Solicita√ß√£o enviada: Inicializando Engine ${site}...</div>`;

            try {
                const res = await fetch('/admin/crawl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ site })
                });
                const data = await res.json();
                if (data.success) {
                    startLogPolling();
                    loadDashboard();
                } else {
                    appendTerminal(`ERRO: ${data.error}`, 'error');
                }
            } catch (e) {
                appendTerminal(`FALHA DE CONEX√ÉO: Tente novamente.`, 'error');
            }
        }

        async function runAllCrawlers() {
            localStorage.setItem('running_crawler', 'all');
            appendTerminal(`üöÄ SEQU√äNCIA GLOBAL ATIVADA: Processando todos os leiloeiros...`, 'info');
            try {
                const res = await fetch('/admin/crawl-all', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401) return logout();
                startLogPolling();
            } catch (e) {
                appendTerminal(`FALHA AO DISPARAR SEQU√äNCIA.`, 'error');
            }
        }

        function startLogPolling() {
            if (window.logPolling) clearInterval(window.logPolling);
            window.logPolling = setInterval(async () => {
                const res = await fetch('/admin/logs', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.status === 401) return logout();
                const data = await res.json();
                if (data.success && data.logs) {
                    updateTerminal(data.logs);
                    if (data.logs.includes('Finalizado')) {
                        localStorage.removeItem('running_crawler');
                        loadDashboard();
                    }
                }
            }, 1500);
        }

        function updateTerminal(logs) {
            const consoleEl = document.getElementById('crawler-console');
            const lines = logs.split('\n').map(line => {
                let type = '';
                if (line.includes('ERROR') || line.includes('Erro')) type = 'line-error';
                else if (line.includes('Success') || line.includes('Saved') || line.includes('Finalizado')) type = 'line-success';
                else if (line.includes('üîç') || line.includes('Starting')) type = 'line-info';
                return `<div class="line ${type}">${line}</div>`;
            }).join('');
            consoleEl.innerHTML = lines;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function appendTerminal(msg, type) {
            const consoleEl = document.getElementById('crawler-console');
            consoleEl.innerHTML += `<div class="line line-${type}">${msg}</div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function clearTerminal() {
            document.getElementById('crawler-console').innerHTML = '<div class="line line-info">Terminal limpo. Aguardando atividade...</div>';
        }

        function logout() {
            localStorage.removeItem('admin_token');
            window.location.href = '/login.html';
        }

        // Shared Actions
        async function cleanExpired() {
            if (!confirm('Deseja realmente remover leil√µes que j√° foram encerrados?')) return;
            const res = await fetch('/admin/clean', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            alert(`Limpeza conclu√≠da! ${data.removed} ve√≠culos removidos.`);
            loadDashboard();
        }

        async function refreshDB() {
            await fetch('/admin/refresh-db', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
            loadDashboard();
        }

        function showSection(id) {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            const target = document.getElementById('section-' + id);
            if (target) target.style.display = 'block';

            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.querySelector(`[onclick="showSection('${id}')"]`).classList.add('active');
        }

        init();
    </script>
</body>

</html>

});
const data = await res.json();

const resDiv = document.getElementById('ai-result');
resDiv.style.display = 'block';

if (data.success) {
resDiv.innerHTML = `<span style="color: green;">‚úÖ Sucesso! <b>${data.count}</b> ve√≠culos encontrados e salvos.</span>`;
setTimeout(loadDashboard, 2000);
} else {
resDiv.innerHTML = `<span style="color: red;">‚ùå Erro: ${data.error}</span>`;
}
} catch (e) {
alert('Erro de conex√£o');
} finally {
overlay.style.display = 'none';
}
}

async function uploadBranding(type) {
const input = document.getElementById(`upload-${type}`);
const file = input.files[0];
if (!file) return alert('Selecione uma imagem!');

const reader = new FileReader();
reader.onload = async (e) => {
const base64Data = e.target.result;
const overlay = document.getElementById('loading-overlay');
overlay.style.display = 'flex';

try {
const res = await fetch('/admin/upload-branding', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${token}`
},
body: JSON.stringify({ type, base64Data })
});
const data = await res.json();
if (data.success) {
alert(`${type.toUpperCase()} atualizado com sucesso! Reinicie a p√°gina para ver as mudan√ßas.`);
input.value = '';
// Opcional: Recarregar a p√°gina ou atualizar o CSS via JS
if (type === 'hero') {
document.body.style.setProperty('--hero-bg', `url('/img/hero-bg.jpg?t=${Date.now()}')`);
}
} else {
alert('Erro: ' + data.error);
}
} catch (err) {
alert('Erro ao enviar imagem');
} finally {
overlay.style.display = 'none';
}
};
reader.readAsDataURL(file);
}

function previewImage(input, previewId) {
const file = input.files[0];
if (file) {
const reader = new FileReader();
reader.onload = function (e) {
const preview = document.getElementById(previewId);
preview.src = e.target.result;
document.getElementById(`${previewId}-container`).style.display = 'block';
document.getElementById('preview-placeholder').style.display = 'none';
}
reader.readAsDataURL(file);
}
}

function logout() {
localStorage.removeItem('admin_token');
window.location.href = '/login.html';
}

async function refreshDB() {
const overlay = document.getElementById('loading-overlay');
overlay.style.display = 'flex';
document.getElementById('loading-msg').innerText = 'Recarregando Banco de Dados...';

try {
const res = await fetch('/admin/refresh-db', {
method: 'POST',
headers: {
'Authorization': `Bearer ${token}`
}
});
const data = await res.json();
if (data.success) {
alert('‚úÖ ' + data.message);
loadDashboard();
} else {
alert('‚ùå Erro: ' + data.error);
}
} catch (e) {
alert('Erro de conex√£o');
} finally {
overlay.style.display = 'none';
}
}

loadDashboard();
setInterval(loadDashboard, 60000);
</script>
</body>

</html>