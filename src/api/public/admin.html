<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - CAR Leil√µes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0a0a0b;
            color: #fff;
            font-family: 'Inter', sans-serif;
        }

        .card {
            background-color: #151516;
            border-color: #2a2a2d;
            color: #fff;
        }

        .btn-primary {
            background-color: #FF9F1C;
            border-color: #FF9F1C;
        }

        .btn-primary:hover {
            background-color: #e68e19;
            border-color: #e68e19;
        }

        .table {
            color: #ccc;
        }

        .table-dark {
            background-color: #151516;
        }
    </style>
    <script>
        // Auth Protection
        const token = localStorage.getItem('admin_token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // Verify valid token
        fetch('/admin/check-auth', {
            headers: { 'Authorization': `Bearer ${token}` }
        }).then(res => {
            if (!res.ok) {
                localStorage.removeItem('admin_token');
                window.location.href = '/login.html';
            }
        }).catch(() => {
            // If API is down, maybe let them stay or redirect? 
            // Redirecting is safer.
            // window.location.href = '/login.html';
        });

        // Add token to future fetching
        const originalFetch = window.fetch;
        window.fetch = function () {
            let [resource, config] = arguments;
            if (config == null) config = {};
            if (config.headers == null) config.headers = {};

            // Add Authorization header if not present
            if (!config.headers['Authorization']) {
                config.headers['Authorization'] = `Bearer ${localStorage.getItem('admin_token')}`;
            }

            return originalFetch(resource, config);
        };
    </script>
</head>

<body>
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üîß Painel Administrativo</h1>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
        </div>
        <hr>

        <div class="row g-4">
            <!-- Stats -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Estat√≠sticas</div>
                    <div class="card-body">
                        <ul id="stats-list" class="list-group list-group-flush bg-transparent">
                            <li class="list-group-item bg-transparent text-white">Carregando...</li>
                        </ul>
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">Atualizado em tempo real</small>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">A√ß√µes Manuais</div>
                    <div class="card-body">
                        <h5>Crawlers</h5>
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-outline-light text-start" onclick="runCrawler('freitas')">
                                <i class="fas fa-play me-2"></i> Freitas Leiloeiro
                            </button>
                            <button class="btn btn-outline-light text-start" onclick="runCrawler('sodre')">
                                <i class="fas fa-play me-2"></i> Sodr√© Santoro
                            </button>
                            <button class="btn btn-outline-light text-start" onclick="runCrawler('copart')">
                                <i class="fas fa-play me-2"></i> Copart
                            </button>
                            <button class="btn btn-outline-light text-start" onclick="runCrawler('palacio')">
                                <i class="fas fa-play me-2"></i> Pal√°cio dos Leil√µes
                            </button>
                        </div>

                        <h5>Manuten√ß√£o</h5>
                        <button class="btn btn-danger w-100" onclick="cleanExpired()">
                            <i class="fas fa-trash-alt me-2"></i> Limpar Leil√µes Expirados
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-5 text-center">
            <a href="/" class="btn btn-secondary">Voltar para Home</a>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8181';

        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/stats`);
                const data = await res.json();
                if (data.success) {
                    const list = document.getElementById('stats-list');
                    list.innerHTML = `
                        <li class="list-group-item bg-transparent text-white d-flex justify-content-between">
                            <strong>Total Ve√≠culos</strong> <span>${data.stats.total}</span>
                        </li>
                    `;
                    Object.entries(data.stats.porSite).forEach(([site, count]) => {
                        list.innerHTML += `
                            <li class="list-group-item bg-transparent text-white d-flex justify-content-between">
                                <span>${site}</span> <span>${count}</span>
                            </li>
                        `;
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function runCrawler(site) {
            if (!confirm(`Iniciar crawler para ${site}?`)) return;
            try {
                const res = await fetch(`${API_URL}/admin/crawl`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ site })
                });
                const data = await res.json();
                alert(data.message || data.error);
            } catch (e) { alert('Erro ao iniciar crawler'); }
        }

        async function cleanExpired() {
            if (!confirm(`Tem certeza que deseja limpar os leil√µes expirados?`)) return;
            try {
                const res = await fetch(`${API_URL}/admin/clean`, { method: 'POST' });
                const data = await res.json();
                alert(`Limpeza conclu√≠da. Removidos: ${data.removed || 0}`);
                loadStats();
            } catch (e) { alert('Erro ao limpar'); }
        }

        loadStats();
        // Auto refresh
        setInterval(loadStats, 30000);
    </script>
</body>

</html>